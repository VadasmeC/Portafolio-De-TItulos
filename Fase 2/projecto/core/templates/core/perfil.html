{% extends 'core/base.html' %}

{% block content %}
<div class="perfil-container">
    <div class="perfil-card">
        <div class="perfil-foto">
        </div>
        <h2>{{ user.first_name }} {{ user.last_name }}</h2>
        <div class="contacto-info">
            <p><strong>Tarjeta de Contacto</strong></p>
            <p>Fono: {{ user.personas.PERS_TELEFONO }}</p>
            <p>Rut: {{ user.personas.PERS_RUT }}</p>
            <p>Correo: {{ user.email }}</p>
        </div>
    </div>
    
    <div class="perfil-descripcion">
        <h3>Descripción</h3>
        <p>...</p>
        <div class="dropdown">
          <h2>Seleccione su tipo de perfil</h2>
          <ul>
              {% for tipo_perfil, cursos in perfiles_con_cursos.items %}
                <li>
                  <strong>{{ tipo_perfil }}</strong>
                  <ul>
                      {% for curso in cursos %}
                          <li>
                              <a href="#" class="seleccionar-curso" data-perfil-id="{{ curso.perfil_id }}" data-curso-id="{{ curso.curso }}">
                                Curso: {{ curso.curso }}
                              </a>
                          </li>
                      {% endfor %}
                  </ul>
                </li>
              {% empty %}
                <li>No hay perfiles disponibles.</li>
              {% endfor %}
          </ul>
        </div>
    </div>

    <div class="container mt-3">
        {% if es_profesor %}
            <p>Bienvenido, profesor. Tienes acceso a secciones especiales para profesores.</p>
            <a href="{% url 'test' %}" class="btn btn-sm btn-success">Nuevo perfil</a>
            {% elif es_alumno %}
            <p>Bienvenido, estudiante. Aquí puedes ver las secciones especiales para estudiantes.</p>
        {% else %}
            <p>Bienvenido, usuario.</p>
        {% endif %}
    </div>

    <div class="perfil-publicaciones">
        <p>CANTIDAD DE PUBLICACIONES: pendiente</p>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.querySelectorAll('.seleccionar-curso').forEach(function(item) {
        item.addEventListener('click', function(e) {
            e.preventDefault();
  
            // Obtener el perfil y curso seleccionados
            const perfilId = this.getAttribute('data-perfil-id');
            const cursoId = this.getAttribute('data-curso-id');
  
            // Enviar la selección al servidor vía AJAX
            fetch("{% url 'perfil' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                body: JSON.stringify({
                    perfil_id: perfilId,
                    curso_id: cursoId,
                })
            }).then(response => response.json()).then(data => {
                if (data.success) {
                    // Redirigir según el tipo de perfil
                    if (data.perfil_tipo === 'Profesor') {
                        window.location.href = "{% url 'index_profesor' %}";
                    } else if (data.perfil_tipo === 'Alumno') {
                        window.location.href = "{% url 'ver_notas_estudiante' %}";
                    }
                } else {
                    alert('Hubo un problema con la selección. Por favor, inténtalo de nuevo.');
                }
            });
        });
    });
</script>

{% endblock %}